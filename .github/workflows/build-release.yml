name: Build Release Binaries

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-linux-x64:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake git pkg-config zlib1g-dev

    - name: Build static TagLib
      run: |
        git clone --depth=1 --recursive https://github.com/taglib/taglib.git
        cd taglib
        cmake -DCMAKE_BUILD_TYPE=Release \
              -DBUILD_SHARED_LIBS=OFF \
              -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
              -DCMAKE_INSTALL_PREFIX=$GITHUB_WORKSPACE/taglib-static .
        make -j$(nproc)
        make install

    - name: Build amalyzer
      run: |
        rm -rf build
        mkdir build
        cd build

        cmake .. -DTAGLIB_STATIC_ROOT="$GITHUB_WORKSPACE/taglib-static"
        cmake --build . --config Release

    - name: Package binary (ZIP)
      run: |
        mkdir -p release/amalyzer-linux-x64
        cp build/amalyzer release/amalyzer-linux-x64/
        cp README.md release/amalyzer-linux-x64/ 2>/dev/null || true
        cd release
        zip -r amalyzer-linux-x64.zip amalyzer-linux-x64/

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: amalyzer-linux-x64
        path: release/amalyzer-linux-x64.zip

  build-linux-arm64:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
      with:
        platforms: arm64

    - name: Build Linux ARM64 inside Docker
      run: |
        docker run --rm --platform linux/arm64 \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          arm64v8/ubuntu:22.04 bash -c "
            apt-get update && \
            apt-get install -y build-essential cmake git pkg-config zlib1g-dev && \

            git clone --depth=1 --recursive https://github.com/taglib/taglib.git && \
            cd taglib && \
            cmake -DCMAKE_BUILD_TYPE=Release \
                  -DBUILD_SHARED_LIBS=OFF \
                  -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
                  -DCMAKE_INSTALL_PREFIX=/workspace/taglib-static . && \
            make -j\$(nproc) && make install && \

            cd /workspace && \
            rm -rf build && mkdir build && cd build && \
            cmake .. -DTAGLIB_STATIC_ROOT=/workspace/taglib-static && \
            make -j\$(nproc)
          "

    - name: Package binary (ZIP)
      run: |
        mkdir -p release/amalyzer-linux-arm64
        cp build/amalyzer release/amalyzer-linux-arm64/
        cp README.md release/amalyzer-linux-arm64/ 2>/dev/null || true
        cd release
        zip -r amalyzer-linux-arm64.zip amalyzer-linux-arm64/

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: amalyzer-linux-arm64
        path: release/amalyzer-linux-arm64.zip

  create-release:
    needs: [build-linux-x64, build-linux-arm64]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
    - name: Download x64 artifact
      uses: actions/download-artifact@v4
      with:
        name: amalyzer-linux-x64
        path: ./artifacts

    - name: Download ARM64 artifact
      uses: actions/download-artifact@v4
      with:
        name: amalyzer-linux-arm64
        path: ./artifacts

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ./artifacts/amalyzer-linux-x64.zip
          ./artifacts/amalyzer-linux-arm64.zip
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
